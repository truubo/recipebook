@model Recipebook.Models.ViewModels.ListEditVm
@addTagHelper *, Microsoft.AspNetCore.Mvc.TagHelpers

@{
    ViewData["Title"] = "Create List";
}

<div class="list-form-page">
    <h1>Create New List</h1>

    <div class="card shadow-sm mb-4">
        <div class="card-body">
            @* POSTs to ListsController.Create (HttpPost) *@
            <form asp-action="Create" method="post">
                <div asp-validation-summary="ModelOnly" class="text-danger mb-3"></div>

                @* List name (required by validation on the VM/model) *@
                <div class="mb-3">
                    <label asp-for="List.Name" class="form-label fw-bold"></label>
                    <input asp-for="List.Name" class="form-control" />
                    <span asp-validation-for="List.Name" class="text-danger"></span>
                </div>

                @* Privacy toggle: owner-visible only when checked *@
                <div class="form-check mb-3">
                    <input asp-for="List.Private" class="form-check-input" id="PrivateCheck" />
                    <label asp-for="List.Private" class="form-check-label fw-bold" for="PrivateCheck">Private List?</label>
                </div>

                @* ? List type: Recipes vs Ingredients (enum with name + description) *@
                <div class="mb-3">
                    <label asp-for="List.ListType" class="form-label fw-bold">List Type</label>

                    @{
                        var listTypeItems = Enum.GetValues(typeof(Recipebook.Models.ListType))
                        .Cast<Recipebook.Models.ListType>()
                        .Select(e =>
                        {
                            var field = e.GetType().GetField(e.ToString());
                            var attr = (System.ComponentModel.DescriptionAttribute?)Attribute
                                            .GetCustomAttribute(field!, typeof(System.ComponentModel.DescriptionAttribute));
                            var text = string.IsNullOrWhiteSpace(attr?.Description)
                                            ? e.ToString()
                                            : $"{e} - {attr.Description}";
                            return new SelectListItem { Value = ((int)e).ToString(), Text = text, Selected = (Model.List.ListType == e) };
                        }).ToList();
                    }

                    <select asp-for="List.ListType" asp-items="listTypeItems" class="form-select" id="listTypeSelect"></select>

                    <span asp-validation-for="List.ListType" class="text-danger"></span>
                </div>

                <div class="mb-3" id="recipeSelectSection">
                    <label class="form-label fw-bold" id="recipeSelectLabel">Add Recipes</label>

                    <div class="dropdown" id="listsRecipesDropdown" data-bs-auto-close="outside">
                        <!-- Hidden multi-select that MVC binds -->
                        <select id="SelectedRecipeIds"
                                name="SelectedRecipeIds"
                                asp-items="Model.RecipeChoices"
                                multiple="multiple"
                                class="d-none">
                        </select>

                        <!-- The clickable dropdown button -->
                        <button class="form-control dropdown-toggle"
                                type="button"
                                data-bs-toggle="dropdown"
                                aria-expanded="false">
                            <span id="listsRecipesDropdownText">Select recipes...</span>
                        </button>

                        <!-- Dropdown menu -->
                        <ul class="dropdown-menu p-2">
                            <li>
                                <input type="text"
                                       class="form-control my-2"
                                       placeholder="Search..."
                                       oninput="searchListRecipes(this)" />
                            </li>

                            <li>
                                <ul id="listsRecipesList" class="list-unstyled mb-0">
                                    @foreach (var recipe in Model.RecipeChoices)
                                    {
                                        <li>
                                            <a href="#"
                                               class="dropdown-item list-recipe-option @(recipe.Selected ? "active" : "")"
                                               data-id="@recipe.Value"
                                               data-name="@recipe.Text"
                                               onclick="toggleListRecipe(event, this)">
                                                @recipe.Text
                                            </a>
                                        </li>
                                    }
                                </ul>
                            </li>
                        </ul>
                    </div>

                    <span asp-validation-for="SelectedRecipeIds" class="text-danger"></span>
                    <small id="recipeSelectHelp" class="text-muted"></small>
                </div>

                @* Primary actions: submit or cancel (cancel uses history.back for a simple UX) *@
                <div class="d-flex justify-content-center gap-2">
                    <button type="submit" class="btn btn-success btn-lg">
                        <i class="bi bi-plus-circle"></i> Create
                    </button>
                    <a onclick="history.back()" class="btn btn-brown btn-lg">Cancel</a>
                </div>
            </form>
        </div>
    </div>
</div>

@section Scripts {
    <partial name="_ValidationScriptsPartial" />
    <script src="~/js/listsHandler.js"></script>
}