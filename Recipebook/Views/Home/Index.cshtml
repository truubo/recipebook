@model IEnumerable<Recipebook.Models.Recipe>
@using System.Linq
@using Recipebook.Models
@using System.Security.Claims

@{
    ViewData["Title"] = "Home";

    var recipes = Model ?? Enumerable.Empty<Recipe>();
    var currentUserEmail = User?.Identity?.Name;

    // Only show recipes that:
    // 1. Are not archived
    // 2. Have an image filename
    // 3. Are public OR owned by the current user
    var topRecipes = recipes
        .Where(r =>
            !r.IsArchived &&
            !string.IsNullOrWhiteSpace(r.ImageFileName) &&
            (!r.Private || r.AuthorEmail == currentUserEmail))
        .OrderByDescending(r => r.RecipeVotes?.Count(v => v.IsLike) ?? 0)
        .ThenBy(r => r.Title)
        .Take(5)
        .ToList();

    var hasTopRecipes = topRecipes.Any();
}

<div class="home-hero-wrapper">
    @if (hasTopRecipes)
    {
        <div id="topRecipeHero"
             class="carousel slide home-hero-carousel"
             data-bs-ride="carousel"
             data-bs-interval="7000">

            <!-- Indicators -->
            <div class="carousel-indicators home-hero-indicators">
                @for (int i = 0; i < topRecipes.Count; i++)
                {
                    <button type="button"
                            data-bs-target="#topRecipeHero"
                            data-bs-slide-to="@i"
                            class="@(i == 0 ? "active" : "")"
                            aria-current="@(i == 0 ? "true" : "false")"
                            aria-label="Slide @(i + 1)">
                    </button>
                }
            </div>

            <!-- Slides -->
            <div class="carousel-inner">
                @for (int i = 0; i < topRecipes.Count; i++)
                {
                    var recipe = topRecipes[i];
                    var likes = recipe.RecipeVotes?.Count(v => v.IsLike) ?? 0;
                    var dislikes = recipe.RecipeVotes?.Count(v => !v.IsLike) ?? 0;

                    var uid = User?.FindFirstValue(ClaimTypes.NameIdentifier);
                    Recipebook.Models.RecipeVote? userVote = null;
                    if (User?.Identity is { IsAuthenticated: true } && recipe.RecipeVotes != null && uid != null)
                    {
                        userVote = recipe.RecipeVotes.FirstOrDefault(v => v.UserId == uid);
                    }
                    var userLiked = userVote?.IsLike == true;
                    var userDisliked = userVote?.IsLike == false;

                    <div class="carousel-item @(i == 0 ? "active" : "")">
                        <div class="home-hero-frame">
                            <div class="home-hero-content">
                                <!-- Caption column -->
                                <div class="home-hero-caption">
                                    <div class="mb-2">
                                        <span class="badge rounded-pill home-hero-pill">
                                            Top Recipe
                                        </span>
                                    </div>

                                    <h2 class="home-hero-title">
                                        @recipe.Title
                                    </h2>

                                    @if (!string.IsNullOrWhiteSpace(recipe.Description))
                                    {
                                        <p class="home-hero-subtitle">
                                            @recipe.Description
                                        </p>
                                    }

                                    <div class="home-hero-stats">
                                        @if (User?.Identity is { IsAuthenticated: true })
                                        {
                                            <!-- Like -->
                                            <form asp-controller="Votes"
                                                  asp-action="ToggleLike"
                                                  method="post"
                                                  class="d-inline">
                                                @Html.AntiForgeryToken()
                                                <input type="hidden" name="recipeId" value="@recipe.Id" />
                                                <input type="hidden" name="returnUrl" value="@Context.Request.Path@Context.Request.QueryString" />
                                                <button type="submit"
                                                        class="btn btn-sm @(userLiked ? "btn-success" : "btn-outline-success") rounded-pill px-3 home-hero-vote-btn"
                                                        title="Like this recipe">
                                                    <span class="me-1">👍</span>
                                                    <span>@likes</span>
                                                </button>
                                            </form>

                                            <!-- Dislike -->
                                            <form asp-controller="Votes"
                                                  asp-action="ToggleDislike"
                                                  method="post"
                                                  class="d-inline">
                                                @Html.AntiForgeryToken()
                                                <input type="hidden" name="recipeId" value="@recipe.Id" />
                                                <input type="hidden" name="returnUrl" value="@Context.Request.Path@Context.Request.QueryString" />
                                                <button type="submit"
                                                        class="btn btn-sm @(userDisliked ? "btn-danger" : "btn-outline-danger") rounded-pill px-3 home-hero-vote-btn"
                                                        title="Dislike this recipe">
                                                    <span class="me-1">👎</span>
                                                    <span>@dislikes</span>
                                                </button>
                                            </form>
                                        }
                                        else
                                        {
                                            <span class="badge rounded-pill home-hero-like-pill">
                                                👍 @likes
                                            </span>
                                            <span class="badge rounded-pill home-hero-dislike-pill">
                                                👎 @dislikes
                                            </span>
                                        }
                                    </div>

                                    <div class="home-hero-actions">
                                        <a asp-controller="Recipes"
                                           asp-action="Details"
                                           asp-route-id="@recipe.Id"
                                           class="btn btn-primary home-hero-primary-btn">
                                            View Recipe
                                        </a>
                                        <a asp-controller="Recipes"
                                           asp-action="Index"
                                           class="btn btn-outline-secondary home-hero-secondary-btn">
                                            Browse All Recipes
                                        </a>
                                    </div>
                                </div>

                                <!-- Image column -->
                                <div class="home-hero-media">
                                    @if (recipe.ImageFileName != null && recipe.ImageFileName != "")
                                    {
                                        <img src="/img/recipes/@recipe.ImageFileName"
                                             class="home-hero-img"
                                             alt="@recipe.Title" />
                                    }
                                    else
                                    {
                                        <img src="/img/recipebook_placeholder.jpg"
                                             class="home-hero-img"
                                             alt="@recipe.Title" />
                                    }
                                </div>
                            </div>
                        </div>
                    </div>
                }
            </div>

            <!-- Controls -->
            <button class="carousel-control-prev"
                    type="button"
                    data-bs-target="#topRecipeHero"
                    data-bs-slide="prev">
                <span class="carousel-control-prev-icon" aria-hidden="true"></span>
                <span class="visually-hidden">Previous</span>
            </button>
            <button class="carousel-control-next"
                    type="button"
                    data-bs-target="#topRecipeHero"
                    data-bs-slide="next">
                <span class="carousel-control-next-icon" aria-hidden="true"></span>
                <span class="visually-hidden">Next</span>
            </button>
        </div>
    }
    else
    {
        <div class="home-hero-empty">
            <div class="home-hero-empty-inner">
                <h1 class="display-6 mb-3">Welcome to Recipebook</h1>
                <p class="lead mb-4">
                    Once you add some non-archived, non-private recipes with images and likes, they’ll appear here as top picks.
                </p>
                <a asp-controller="Recipes" asp-action="Create" class="btn btn-primary me-2">
                    Add a Recipe
                </a>
                <a asp-controller="Recipes" asp-action="Index" class="btn btn-outline-secondary">
                    Browse Recipes
                </a>
            </div>
        </div>
    }
</div>


<!-- Below-hero CTA row -->
<div class="container my-4">
    <div class="row">
        <div class="col-md-8 mb-3 mb-md-0">
            <h3 class="h5 fw-bold mb-2">Discover and vote on recipes</h3>
            <p class="mb-0">
                Use the like and dislike buttons on each recipe to influence what shows up in the hero carousel.
            </p>
        </div>
        <div class="col-md-4 text-md-end">
            <a asp-controller="Recipes" asp-action="Index" class="btn btn-outline-secondary me-2">
                Browse All Recipes
            </a>
            <a asp-controller="Recipes" asp-action="Create" class="btn btn-primary">
                Add a Recipe
            </a>
        </div>
    </div>
</div>
