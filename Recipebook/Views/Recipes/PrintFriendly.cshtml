@* ===============================================================
   Recipe Details View
   - Back button: simple link to /Recipes/Index (no auto-redirect)
   - Favorites + Add-to-List unchanged
   =============================================================== *@

@model Recipebook.Models.Recipe
@using System.Security.Claims
@inject Recipebook.Services.Interfaces.ITextNormalizationService _textNormalizer

@{
    Layout = null; // prevents the entire layout from loading (navbar and footer not needed)
}

<link rel="stylesheet" href="~/lib/bootstrap/dist/css/bootstrap.min.css" />
<link rel="stylesheet" href="~/css/site.css" asp-append-version="true" />
<link rel="stylesheet" href="~/Recipebook.styles.css" asp-append-version="true" />
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.min.css">
<link rel="stylesheet" href="~/css/sitetheme.css" />
<link rel="stylesheet" href="~/css/print.css" />
<div class="details-page position-relative">

    @* ===============================================================
    HEADER: Title, categories, author, privacy badge
    =============================================================== *@
    <div class="details-header text-center mt-5">
        <h1 class="recipe-title">@Html.DisplayFor(model => model.Title)</h1>
    </div>

    @* ===============================================================
    BODY: Description, (ADDED Timing), Ingredients, Directions
    =============================================================== *@
    <div class="details-body mt-4">

        @* Timing bar only if any timing values present; formatted strings come from the model. *@
        @if (Model.PrepTimeMinutes.HasValue || Model.CookTimeMinutes.HasValue)
        {
            <div class="timing-bar text-center py-3 px-2 mt-4 border-top border-bottom border-brown">
                <div class="d-flex justify-content-center flex-wrap gap-5">
                    <div>
                        <strong>Prep Time:</strong> <span>@Model.FormattedPrepTime</span>
                    </div>
                    <div>
                        <strong>Cook Time:</strong> <span>@Model.FormattedCookTime</span>
                    </div>
                    <div>
                        <strong>Total Time:</strong> <span>@Model.FormattedTotalTime</span>
                    </div>
                </div>
            </div>
        }
        else
        {
            <p class="text-muted mt-4 text-center">No timing information available.</p>
        }
        @* ==== END UPDATED ==== *@

        <h4 class="section-title mt-4">Ingredients</h4>
        @{
            // Group by ingredient + unit, auto-sum quantities, trim trailing zeros
            var ingredientLines = (Model.IngredientRecipes ?? Enumerable.Empty<Recipebook.Models.IngredientRecipe>())
            .GroupBy(ir => new { ir.IngredientId, ir.Unit })
            .Select(g => new
            {
                Name = g.First().Ingredient?.Name ?? "Unknown",
                Unit = g.Key.Unit,
                Qty = g.Sum(x => x.Quantity)
            })
            .OrderBy(x => x.Name)
            .ToList();
        }


        @if (ingredientLines.Any())
        {
            <ul class="list-group list-group-flush">
                @foreach (var row in ingredientLines)
                {
                    <li class="list-group-item bg-brown border-brown rounded-2">
                        @_textNormalizer.FormatIngredientDisplay(row.Qty.ToString("0.####"), row.Unit, row.Name)
                    </li>
                }
            </ul>
        }
        else
        {
            <p class="text-muted">No ingredients added.</p>
        }

        <h4 class="section-title mt-4">Directions</h4>
        <link rel="stylesheet" href="/css/directions.css" />
        @foreach (Direction d in Model.DirectionsList)
        {
            <div class="direction p-3 bg-brown border-brown rounded-2">
                <div class="step-number">@d.StepNumber</div>
                <div class="text">@d.StepDescription</div>
            </div>
        }
    </div>
</div>
<script>
    window.onload = function() { window.print(); }
</script>