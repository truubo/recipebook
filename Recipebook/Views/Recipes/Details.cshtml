@* ===============================================================
   Recipe Details View
   - Goal: Keep "Back" behavior stable (returns to Recipes list or tab)
   - Move the Favorite (star) toggle to the top-right, next to Edit/Delete
   - Keep star toggle AJAX-only to avoid polluting browser history
   - EXTENSIVE MARKUP COMMENTS added for clarity (no logic changes)
   =============================================================== *@

@model Recipebook.Models.Recipe
@using System.Security.Claims
@using Microsoft.AspNetCore.Mvc.Rendering  @* needed for SelectListItem cast below *@

@{
    ViewData["Title"] = "Recipe Details";

    // Compute a stable "Back" target.
    // If the user arrived from any /Recipes URL, send them back there (preserves tab/search).
    // Otherwise, fall back to Recipes/Index.
    var referer = Context?.Request?.Headers["Referer"].ToString() ?? "";
    var backUrl =
        (!string.IsNullOrWhiteSpace(referer) && referer.Contains("/Recipes", StringComparison.OrdinalIgnoreCase))
            ? referer
            : Url.Action("Index", "Recipes");

    // Determine current user's Id for favorite-state detection
    var uid = User.FindFirstValue(ClaimTypes.NameIdentifier);

    // A recipe is "favorited" if any Favorite row exists for (this user, this recipe).
    // (null-propagation to be safe when Favorites is not included)
    var isFav = User.Identity.IsAuthenticated && (Model.Favorites?.Any(f => f.UserId == uid) ?? false);

    // Is the current user the author? (used to gate Edit/Delete)
    var isOwner = User.Identity.IsAuthenticated && (User.Identity.Name == (string)ViewData["AuthorEmail"]);

    // Lists for Add-to-List modal (provided by controller; safe if null)
    var userLists = ViewBag.UserLists as IEnumerable<SelectListItem>;
}

<div class="details-page position-relative">

    @* ===============================================================
    TOP ACTION BAR
    - Left: Back button (links to backUrl; no history.back())
    - Right: (A) Add to List button (if logged in),
    (B) Edit/Delete (if current user is the owner)
    Notes:
    • We render Add-to-List for any authenticated user.
    • The star toggle remains below in the header (unchanged).
    =============================================================== *@
    <div class="details-actions-top d-flex justify-content-between align-items-center w-100">
        @* Back to Recipes/tabs without multiple clicks *@
        <a href="@backUrl" class="btn btn-brown" title="Back to recipes">
            <i class="bi bi-arrow-left-circle"></i>
        </a>

        <div class="d-flex align-items-center gap-2">
            @* Add to List opens a modal; form posts to Lists/AddToList *@
            @if (User.Identity.IsAuthenticated)
            {
                <button type="button"
                        class="btn btn-secondary"
                        data-bs-toggle="modal"
                        data-bs-target="#addToListModal"
                        title="Add to List">
                    <i class="bi bi-list-check"></i>
                </button>
            }

            @* ------------------------------
            Owner-only actions
            - Only the author sees Edit/Delete
            ------------------------------ *@
            @if (isOwner)
            {
                <a asp-action="Edit" asp-route-id="@Model?.Id" class="btn btn-primary" title="Edit">
                    <i class="bi bi-pencil-square"></i>
                </a>
                <a asp-action="Delete" asp-route-id="@Model?.Id" class="btn btn-danger" title="Delete">
                    <i class="bi bi-trash"></i>
                </a>
            }
        </div>
    </div>

    @* ===============================================================
    HEADER: Title, categories, author, privacy badge
    We removed the old star under the title and moved it above.
    (Existing placement of star below is intentionally left intact.)
    =============================================================== *@
    <div class="details-header text-center mt-5">
        <h1 class="recipe-title">@Html.DisplayFor(model => model.Title)</h1>

        <div class="meta-info d-flex justify-content-center flex-wrap gap-3 mt-2">
            <div>
                @* Category badges (link to Category Details) *@
                @if (Model.CategoryRecipes != null && Model.CategoryRecipes.Any())
                {
                    foreach (var cr in Model.CategoryRecipes)
                    {
                        <a asp-controller="Categories"
                           asp-action="Details"
                           asp-route-id="@cr.Category.Id"
                           class="badge bg-info text-dark text-decoration-none me-1">
                            @cr.Category.Name
                        </a>
                    }
                }
                else
                {
                    <span class="text-muted">No Categories</span>
                }
            </div>
        </div>

        @* Author + Privacy badge *@
        <div class="author d-flex justify-content-center align-items-center gap-2 mt-2">
            <span>
                By <a href="mailto:@ViewData["AuthorEmail"]">@ViewData["AuthorEmail"]</a>
            </span>
            <span class="badge @(Model.Private ? "bg-danger" : "bg-success")">
                @(Model.Private ? "Private" : "Public")
            </span>
            <span>
                @if (User.Identity.IsAuthenticated)
                {
                    <form asp-controller="Favorites"
                          asp-action="Toggle"
                          method="post"
                          class="d-inline js-fav-toggle"
                          title="Toggle favorite"
                          aria-label="Toggle favorite">
                        @Html.AntiForgeryToken()
                        <input type="hidden" name="recipeId" value="@Model.Id" />
                        @* returnUrl is a graceful fallback if JS is disabled *@
                        <input type="hidden" name="returnUrl" value="@Context.Request.Path@Context.Request.QueryString" />

                        @* Updated star button *@
                        <button type="submit" class="btn btn-link p-0 star-btn">
                            <i class="bi @(isFav ? "bi-star-fill star" : "bi-star star unchecked")"></i>
                        </button>
                    </form>
                }
            </span>
        </div>
    </div>

    @* ===============================================================
    BODY: Description, Ingredients, Directions
    Keep content structure identical; only added comments and subtle guards.
    =============================================================== *@
    <div class="details-body mt-4">
        @* ------------------------------
        Description
        ------------------------------ *@
        <h4 class="section-title mt-4">Description</h4>
        @if (!string.IsNullOrEmpty(Model.Description))
        {
            <p>@Html.DisplayFor(model => model.Description)</p>
        }
        else
        {
            <p class="text-muted">No description available.</p>
        }

        @* ------------------------------
        Ingredients
        - Renders as a simple list with pluralized unit label
        ------------------------------ *@
        <h4 class="section-title mt-4">Ingredients</h4>
        @if (Model.IngredientRecipes != null && Model.IngredientRecipes.Any())
        {
            <ul class="list-group list-group-flush">
                @foreach (var ir in Model.IngredientRecipes)
                {
                    var unitStr = ir.Unit.ToString();
                    var pluralUnit = ir.Quantity == 1 ? unitStr : unitStr + "s";

                    <li class="list-group-item bg-brown border-brown rounded-2">
                        @ir.Quantity @pluralUnit of @ir.Ingredient.Name
                    </li>
                }
            </ul>
        }
        else
        {
            <p class="text-muted">No ingredients added.</p>
        }

        @* ------------------------------
        Directions
        ------------------------------ *@
        <h4 class="section-title mt-4">Directions</h4>
        <p>@Html.DisplayFor(model => model.Directions)</p>
    </div>
</div>

@* ===============================================================
   Add-to-List Modal
   - Appears only for authenticated users
   - Expects ViewBag.UserLists as IEnumerable<SelectListItem>
   - Posts to Lists/AddToList (normal POST; PRG shows TempData alert)
   =============================================================== *@
@if (User.Identity.IsAuthenticated)
{
    <div class="modal fade" id="addToListModal" tabindex="-1" aria-labelledby="addToListLabel" aria-hidden="true">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 id="addToListLabel" class="modal-title">Add “@Model.Title” to a List</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>

                <form asp-controller="Lists"
                      asp-action="AddToList"
                      method="post">
                    <div class="modal-body">
                        @Html.AntiForgeryToken()
                        <input type="hidden" name="recipeId" value="@Model.Id" />
                        @* Allow controller to redirect back here with TempData alert *@
                        <input type="hidden" name="returnUrl" value="@Context.Request.Path@Context.Request.QueryString" />

                        @if (userLists != null && userLists.Any())
                        {
                            <div class="mb-3">
                                <label for="listId" class="form-label">Choose a list</label>
                                <select id="listId" name="listId" class="form-select" required>
                                    @foreach (var item in userLists)
                                    {
                                        <option value="@item.Value">@item.Text</option>
                                    }
                                </select>
                            </div>
                        }
                        else
                        {
                            <div class="alert alert-info mb-0">
                                You don’t have any lists yet.
                                <a asp-controller="Lists" asp-action="Index" class="alert-link">Create one</a>
                                and try again.
                            </div>
                        }
                    </div>

                    <div class="modal-footer">
                        <button type="button" class="btn btn-outline-secondary" data-bs-dismiss="modal">Cancel</button>
                        <button type="submit" class="btn btn-secondary" @(userLists == null || !userLists.Any() ? "disabled" : null)>
                            <i class="bi bi-plus-circle"></i> Add to List
                        </button>
                    </div>
                </form>
            </div>
        </div>
    </div>
}

@section Scripts {
    <script>
        // ===============================================================
        // AJAX Favorite Toggle
        // - Prevents full-page POST redirects which would create extra
        //   history entries (so Back always returns to Recipes once).
        // - Uses optimistic UI to flip the star icon immediately.
        // - Keeps the user in place; no scrolling or navigation.
        // ===============================================================
        document.addEventListener('submit', async (e) => {
            const form = e.target;
            if (!form.matches('form.js-fav-toggle')) return;
            e.preventDefault();

            const fd = new FormData(form);

            try {
                await fetch(form.action, {
                    method: 'POST',
                    body: fd,
                    headers: { 'X-Requested-With': 'XMLHttpRequest' } // lets server know it's an AJAX request
                });

                // Flip the star appearance immediately (optimistic UI)
                const icon = form.querySelector('i');
                if (icon) {
                    icon.classList.toggle('bi-star');
                    icon.classList.toggle('bi-star-fill');
                    icon.classList.toggle('text-warning');
                }
            } catch {
                // Silently ignore errors for now.
                // (Optional: you could show a toast/alert if desired.)
            }
        });
    </script>
}
