@* ===============================================================
   Recipe Details View
   - Back button: simple link to /Recipes/Index (no auto-redirect)
   - Favorites + Add-to-List unchanged
   =============================================================== *@

@model Recipebook.Models.Recipe
@using System.Security.Claims
@using Microsoft.AspNetCore.Mvc.Rendering  @* needed for SelectListItem cast below *@
@inject Recipebook.Services.Interfaces.ITextNormalizationService _textNormalizer

@{
    ViewData["Title"] = "Recipe Details";

    @* Current user's Id; used to detect favorite state without extra queries. *@
    var uid = User.FindFirstValue(ClaimTypes.NameIdentifier);

    @* Favorited iff any Favorite row exists for (this user, this recipe). Safe against null Favorites. *@
    var isFav = User.Identity.IsAuthenticated && (Model.Favorites?.Any(f => f.UserId == uid) ?? false);

    @* Gate Edit/Delete by author check (email compare supplied in ViewData by controller). *@
    var isOwner = User.Identity.IsAuthenticated && (User.Identity.Name == (string)ViewData["AuthorEmail"]);

    @* Lists provided by controller for Add-to-List modal; may be null/empty. *@
    var userLists = ViewBag.UserLists as IEnumerable<SelectListItem>;
}

<div class="details-page position-relative">

    @* ===============================================================
    TOP ACTION BAR
    - Left: Back button (static link to Recipes/Index; no JS)
    - Right: Add to List (if logged in) + Edit/Delete (if owner)
    =============================================================== *@
    <div class="details-actions-top d-flex justify-content-between align-items-center w-100">
        @* Back button — only navigates when clicked *@
        <a onclick="history.back()"
           class="btn btn-brown"
           title="Back to recipes">
            <i class="bi bi-arrow-left-circle"></i>
        </a>

        <div class="d-flex align-items-center gap-2">
            @if (User.Identity.IsAuthenticated)
            {
                @* Quick duplicate/copy action for signed-in users. *@
                <a asp-action="Copy" asp-route-id="@Model.Id" class="btn btn-primary">
                    <i class="bi bi-files"></i>
                </a>

                @* Opens modal to add current recipe to a list. *@
                <a class="btn btn-danger" data-bs-toggle="modal" data-bs-target=".add-to-list-modal" title="Add to List">
                    <i class="bi bi-list-check"></i>
                </a>
            }

            @if (isOwner)
            {
                <a asp-action="Edit" asp-route-id="@Model?.Id" class="btn btn-primary" title="Edit">
                    <i class="bi bi-pencil-square"></i>
                </a>
                <a asp-action="Delete" asp-route-id="@Model?.Id" class="btn btn-danger" title="Delete">
                    <i class="bi bi-trash"></i>
                </a>
            }
        </div>
    </div>

    @* ===============================================================
    HEADER: Title, categories, author, privacy badge
    =============================================================== *@
    <div class="details-header text-center mt-5">
        <img src="/img/recipes/@Model.ImageFileName" style="max-width:100px"/>
        <h1 class="recipe-title">@Html.DisplayFor(model => model.Title)</h1>

        <div class="meta-info d-flex justify-content-center flex-wrap gap-3 mt-2">
            <div>
                @* Show linked category badges or a muted fallback. *@
                @if (Model.CategoryRecipes != null && Model.CategoryRecipes.Any())
                {
                    foreach (var cr in Model.CategoryRecipes)
                    {
                        <a asp-controller="Categories"
                           asp-action="Details"
                           asp-route-id="@cr.Category.Id"
                           class="badge bg-info text-dark text-decoration-none me-1">
                            @cr.Category.Name
                        </a>
                    }
                }
                else
                {
                    <span class="text-muted">No Categories</span>
                }
            </div>
        </div>

        <div class="author d-flex justify-content-center align-items-center gap-2 mt-2">
            <span>
                By <a href="mailto:@ViewData["AuthorEmail"]">@ViewData["AuthorEmail"]</a>
            </span>
            @* Privacy badge reflects Model.Private. *@
            <span class="badge @(Model.Private ? "bg-danger" : "bg-success")">
                @(Model.Private ? "Private" : "Public")
            </span>
            <span>
                @if (User.Identity.IsAuthenticated)
                {
                    @* Favorite toggle posts back; returnUrl enables graceful fallback if JS disabled. *@
                    <form asp-controller="Favorites"
                          asp-action="Toggle"
                          method="post"
                          class="d-inline js-fav-toggle"
                          title="Toggle favorite"
                          aria-label="Toggle favorite"
                          data-recipe-name="@Model.Title">
                        @Html.AntiForgeryToken()
                        <input type="hidden" name="recipeId" value="@Model.Id" />
                        <input type="hidden" name="returnUrl" value="@Context.Request.Path@Context.Request.QueryString" />

                        <button type="submit" class="btn btn-link p-0 star-btn">
                            <i class="bi @(isFav ? "bi-star-fill star" : "bi-star star unchecked")"></i>
                        </button>
                    </form>
                }
            </span>
        </div>
    </div>

    @* ===============================================================
    BODY: Description, (ADDED Timing), Ingredients, Directions
    =============================================================== *@
    <div class="details-body mt-4">

        @* Timing bar only if any timing values present; formatted strings come from the model. *@
        @if (Model.PrepTimeMinutes.HasValue || Model.CookTimeMinutes.HasValue)
        {
            <div class="timing-bar text-center py-3 px-2 mt-4 border-top border-bottom border-brown">
                <div class="d-flex justify-content-center flex-wrap gap-5">
                    <div>
                        <strong>Prep Time:</strong> <span>@Model.FormattedPrepTime</span>
                    </div>
                    <div>
                        <strong>Cook Time:</strong> <span>@Model.FormattedCookTime</span>
                    </div>
                    <div>
                        <strong>Total Time:</strong> <span>@Model.FormattedTotalTime</span>
                    </div>
                </div>
            </div>
        }
        else
        {
            <p class="text-muted mt-4 text-center">No timing information available.</p>
        }
        @* ==== END UPDATED ==== *@


        <h4 class="section-title mt-4">Description</h4>
        @if (!string.IsNullOrEmpty(Model.Description))
        {
            <p>@Html.DisplayFor(model => model.Description)</p>
        }
        else
        {
            <p class="text-muted">No description available.</p>
        }

        <h4 class="section-title mt-4">Ingredients</h4>
        @{
            // Group by ingredient + unit, auto-sum quantities, trim trailing zeros
            var ingredientLines = (Model.IngredientRecipes ?? Enumerable.Empty<Recipebook.Models.IngredientRecipe>())
            .GroupBy(ir => new { ir.IngredientId, ir.Unit })
            .Select(g => new
            {
                Name = g.First().Ingredient?.Name ?? "Unknown",
                Unit = g.Key.Unit,
                Qty = g.Sum(x => x.Quantity)
            })
            .OrderBy(x => x.Name)
            .ToList();
        }


        @if (ingredientLines.Any())
        {
            <ul class="list-group list-group-flush">
                @foreach (var row in ingredientLines)
                {
                    <li class="list-group-item bg-brown border-brown rounded-2">
                        @_textNormalizer.FormatIngredientDisplay(row.Qty.ToString("0.####"), row.Unit, row.Name)
                    </li>
                }
            </ul>
        }
        else
        {
            <p class="text-muted">No ingredients added.</p>
        }

        <h4 class="section-title mt-4">Directions</h4>
        <link rel="stylesheet" href="/css/directions.css" />
        @* Ensure recipes created before the directions overhaul still show directions *@
        @if (Model.DirectionsList == null || !Model.DirectionsList.Any())
        {
            if (Model.Directions != null)
            {
                <p>@Model.Directions</p>
            } else
            {
                <p>No directions.</p>
            }
        } else
        {
            foreach (Direction d in Model.DirectionsList)
            {
                    <div class="direction p-3 bg-brown border-brown rounded-2">
                        <div class="step-number">@d.StepNumber</div>
                        <div class="text">@d.StepDescription</div>
                    </div>
            }
        }
    </div>
</div>

@* ===============================================================
   Add-to-List Modal (unchanged)
   =============================================================== *@
@if (User.Identity.IsAuthenticated)
{
    <div class="modal fade add-to-list-modal" tabindex="-1" aria-labelledby="addToListLabel" aria-hidden="true">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title add-to-list-label">Add “@Model.Title” to a List</h5>
                </div>

                <form asp-controller="Lists"
                      asp-action="AddToList"
                      method="post">
                    <div class="modal-body">
                        @Html.AntiForgeryToken()
                        <input type="hidden" name="recipeId" value="@Model.Id" />
                        @* Fallback navigation after POST (in case AJAX not used). *@
                        <input type="hidden" name="returnUrl" value="@Context.Request.Path@Context.Request.QueryString" />

                        @if (userLists != null && userLists.Any())
                        {
                            <div class="mb-3">
                                <label for="listId" class="form-label">Choose a list</label>
                                <select id="listId" name="listId" class="form-select" required>
                                    @foreach (var item in userLists)
                                    {
                                        <option value="@item.Value">@item.Text</option>
                                    }
                                </select>
                            </div>
                        }
                        else
                        {
                            <div class="alert alert-brown mb-0">
                                You don’t have any lists yet.
                                <a asp-controller="Lists" asp-action="Index" class="alert-brown">Create one</a>
                                and try again.
                            </div>
                        }
                    </div>

                    <div class="modal-footer">
                        <button type="button" class="btn btn-outline-secondary" data-bs-dismiss="modal">Cancel</button>
                        <button type="submit" class="btn btn-secondary" @(userLists == null || !userLists.Any() ? "disabled" : null)>
                            <i class="bi bi-plus-circle"></i> Add to List
                        </button>
                    </div>
                </form>
            </div>
        </div>
    </div>
}

@section Scripts {
    <script>
        let activeAlert = null;

        function showAlert(message, type = "brown") {
            if (activeAlert) {
                activeAlert.remove();
                activeAlert = null;
            }

            const alert = document.createElement("div");
            alert.className = `alert alert-${type} fade show position-fixed bottom-0 end-0 m-3 shadow`;
            alert.style.zIndex = "1050";
            alert.style.transition = "opacity 0.5s ease";
            alert.textContent = message;

            document.body.appendChild(alert);
            activeAlert = alert;

            setTimeout(() => {
                alert.style.opacity = "0";
                setTimeout(() => {
                    alert.remove();
                    activeAlert = null;
                }, 500);
            }, 2500);
        }

        document.addEventListener('submit', async (e) => {
            const form = e.target;
            if (!form.matches('form[action*="Favorites/Toggle"]')) return;
            e.preventDefault();

            const icon = form.querySelector('i');
            if (!icon) return;

            const recipeName = form.dataset.recipeName || "Recipe";
            const wasFav = icon.classList.contains('bi-star-fill');

            icon.classList.toggle('bi-star');
            icon.classList.toggle('bi-star-fill');
            icon.classList.toggle('unchecked');

            try {
                const res = await fetch(form.action, {
                    method: 'POST',
                    body: new FormData(form),
                    headers: { 'X-Requested-With': 'XMLHttpRequest' }
                });

                if (!res.ok) throw new Error();

                showAlert(wasFav
                    ? `Removed '${recipeName}' from favorites.`
                    : `Added '${recipeName}' to favorites!`);
            } catch {
                icon.classList.toggle('bi-star');
                icon.classList.toggle('bi-star-fill');
                icon.classList.toggle('unchecked');
                showAlert(`Something went wrong with '${recipeName}'. Please try again.`, "danger");
            }
        });
    </script>
}
