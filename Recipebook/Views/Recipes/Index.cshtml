@model IEnumerable<Recipe>
@using Microsoft.AspNetCore.Mvc.Rendering
@using System.Security.Claims

@{
    ViewData["Title"] = "Recipes";

    // Preserve current search text across tabs/search submissions.
    var currentSearch = ViewBag.SearchString as string;

    // Active scope tab: "all" | "mine" | "favorites" (default to "all").
    var scope = (string?)ViewBag.Scope ?? "all";

    // Keep current query params when switching tabs.
    string q = currentSearch ?? string.Empty;
    string tag = (ViewBag.TagId is int t) ? t.ToString() : "";
}

<div class="container recipe-index-page">
    <!-- ===================== Page Header ===================== -->
    <div class="index-header">
        <h1>Recipes</h1>
        <p class="lead text-muted">Browse, create, or edit your favorite recipes!</p>
    </div>

    <!-- ===================== Create + Search/Filter ===================== -->
    <div class="mb-3 d-flex justify-content-between align-items-center flex-wrap gap-2">
        @* Create button shown only to authenticated users *@
        @if (User?.Identity is { IsAuthenticated: true })
        {
            <a asp-action="Create" class="btn btn-success">
                <i class="bi bi-plus-circle"></i> Create
            </a>
        }

        <!-- Search + Tag Filter (GET keeps results shareable) -->
        <form asp-action="Index" method="get" class="d-flex gap-2 ms-auto">
            <input type="text"
                   name="searchString"
                   value="@(currentSearch ?? string.Empty)"
                   class="form-control"
                   placeholder="Search by title..." />

            @* Tag list comes from ViewBag.TagList (SelectList).
            First option is neutral "All Tags". *@
            <select name="tagId" class="form-select" asp-items="ViewBag.TagList">
                <option value="">All Tags</option>
            </select>

            @* Preserve the current tab when searching *@
            <input type="hidden" name="scope" value="@scope" />

            <button type="submit" class="btn btn-primary">Search</button>
            <a asp-action="Index" class="btn btn-outline-secondary">Clear</a>
        </form>
    </div>

    <!-- ===================== Tabs: All / My Recipes / Favorites ===================== -->
    <div class="btn-group mb-3" role="group" aria-label="Recipe scope">
        <a class="btn @(scope=="all" ? "btn-primary" : "btn-secondary")"
           asp-action="Index"
           asp-route-scope="all"
           asp-route-searchString="@q"
           asp-route-tagId="@tag">All</a>

        @if (User?.Identity is { IsAuthenticated: true })
        {
            <a class="btn @(scope == "mine" ? "btn-primary" : "btn-secondary")"
               asp-action="Index"
               asp-route-scope="mine"
               asp-route-searchString="@q"
               asp-route-tagId="@tag">My Recipes</a>

            <a class="btn @(scope == "favorites" ? "btn-primary" : "btn-secondary")"
               asp-action="Index"
               asp-route-scope="favorites"
               asp-route-searchString="@q"
               asp-route-tagId="@tag">Favorites</a>
        }
    </div>

    <!-- ===================== Empty-state ===================== -->
    @if (!(Model?.Any() ?? false))
    {
        <div class="alert alert-brown" data-persist="true">No results found.</div>
    }

    <!-- ===================== Results Grid ===================== -->
    <div class="index-card">
        <div class="card-grid">
            @foreach (var item in Model ?? Enumerable.Empty<Recipe>())
            {
                // Show if recipe is public or owned by current user
                if (!item.Private || item.AuthorEmail == User?.Identity?.Name)
                {
                    <div class="recipe-card" style="position:relative;">
                        @if (item.ImageFileName != null && item.ImageFileName != "")
                        {
                            <div style="width:100%;max-height:200px;overflow:hidden;" class="mb-2">
                                <img src="/img/recipes/@item.ImageFileName" class="card-img-top mb-2" style="width:100%;height:100%;object-fit:cover;border-radius:0.75em;border:2px solid #000;">
                            </div>
                        }
                        @{
                            // Current user id (for favorite / vote detection)
                            var uid = User!.FindFirstValue(ClaimTypes.NameIdentifier);

                            // Is this item a favorite for the current user?
                            var isFav = User?.Identity is { IsAuthenticated: true } && (item.Favorites.Any(f => f.UserId == uid));

                            // Owner check (for Edit/Delete visibility in footer)
                            var isOwner = User?.Identity is { IsAuthenticated: true } && item.AuthorEmail == User.Identity.Name;

                            // --- NEW: like / dislike counts + current user vote for this card ---
                            var likeCount = item.RecipeVotes?.Count(v => v.IsLike) ?? 0;
                            var dislikeCount = item.RecipeVotes?.Count(v => !v.IsLike) ?? 0;

                            Recipebook.Models.RecipeVote? userVote = null;
                            if (User?.Identity is { IsAuthenticated: true } && item.RecipeVotes != null)
                            {
                                userVote = item.RecipeVotes.FirstOrDefault(v => v.UserId == uid);
                            }
                            var userLiked = userVote?.IsLike == true;
                            var userDisliked = userVote?.IsLike == false;
                            // --- END NEW ---
                        }

                        <!-- ===================== Card Header ===================== -->
                        @* Keep header on top so body stretched-link won't cover it *@
                        <div class="card-header d-flex justify-content-between align-items-start"
                             style="position:relative; z-index:2; pointer-events:auto;">
                            <h5 class="card-title mb-0">
                                <a asp-action="Details"
                                   asp-route-id="@item.Id"
                                   class="text-decoration-none">
                                    @item.Title
                                </a>
                            </h5>

                            <div class="d-flex align-items-center gap-2" style="pointer-events:auto;">
                                @* NEW: like / dislike for each card (matches Details styling) *@
                                <div class="d-flex align-items-center gap-1">
                                    @if (User?.Identity is { IsAuthenticated: true })
                                    {
                                        <form asp-controller="Votes"
                                              asp-action="ToggleLike"
                                              method="post"
                                              class="d-inline">
                                            @Html.AntiForgeryToken()
                                            <input type="hidden" name="recipeId" value="@item.Id" />
                                            <input type="hidden" name="returnUrl" value="@Context.Request.Path@Context.Request.QueryString" />
                                            <button type="submit"
                                                    class="btn btn-sm @(userLiked ? "btn-success" : "btn-outline-success") rounded-pill d-flex align-items-center px-2"
                                                    title="Like this recipe">
                                                <i class="bi bi-hand-thumbs-up@(userLiked ? "-fill" : "")"></i>
                                                <span class="ms-1">@likeCount</span>
                                            </button>
                                        </form>

                                        <form asp-controller="Votes"
                                              asp-action="ToggleDislike"
                                              method="post"
                                              class="d-inline">
                                            @Html.AntiForgeryToken()
                                            <input type="hidden" name="recipeId" value="@item.Id" />
                                            <input type="hidden" name="returnUrl" value="@Context.Request.Path@Context.Request.QueryString" />
                                            <button type="submit"
                                                    class="btn btn-sm @(userDisliked ? "btn-danger" : "btn-outline-danger") rounded-pill d-flex align-items-center px-2"
                                                    title="Dislike this recipe">
                                                <i class="bi bi-hand-thumbs-down@(userDisliked ? "-fill" : "")"></i>
                                                <span class="ms-1">@dislikeCount</span>
                                            </button>
                                        </form>
                                    }
                                    else
                                    {
                                        <span class="badge bg-dark rounded-pill d-flex align-items-center">
                                            <i class="bi bi-hand-thumbs-up"></i>
                                            <span class="ms-1">@likeCount</span>
                                        </span>
                                        <span class="badge bg-secondary rounded-pill d-flex align-items-center">
                                            <i class="bi bi-hand-thumbs-down"></i>
                                            <span class="ms-1">@dislikeCount</span>
                                        </span>
                                    }
                                </div>
                                @* END NEW *@

                                @* ===================== Favorite Star (KEEP HERE) =====================
                        - Visible to ANY authenticated user
                        - POST to Favorites/Toggle with antiforgery & returnUrl
                        - AJAX handler (below) prevents full-page reload
                        =================================================================== *@
                                @if (User?.Identity is { IsAuthenticated: true })
                                {
                                    <form asp-controller="Favorites"
                                          asp-action="Toggle"
                                          method="post"
                                          class="d-inline"
                                          title="Toggle favorite"
                                          aria-label="Toggle favorite"
                                          data-recipe-name="@item.Title">
                                        @Html.AntiForgeryToken()
                                        <input type="hidden" name="recipeId" value="@item.Id" />
                                        <input type="hidden" name="returnUrl" value="@Context.Request.Path@Context.Request.QueryString" />
                                        <button type="submit"
                                                class="btn btn-link p-0 star-btn"
                                                style="pointer-events:auto;">
                                            <i class="bi @(isFav ? "bi-star-fill star" : "bi-star star unchecked")"></i>
                                        </button>
                                    </form>
                                }
                            </div>
                        </div>

                        <!-- ===================== Card Body ===================== -->
                        <div class="card-body position-relative">
                            <div class="categories mb-2 d-flex align-items-center flex-wrap">
                                @* Private badge FIRST — same pill sizing but custom color *@
                                @if (item.Private)
                                {
                                    <span class="badge pill private-pill me-1">Private</span>
                                }

                                @* Categories *@
                                @if (item.CategoryRecipes != null && item.CategoryRecipes.Any())
                                {
                                    var categories = item.CategoryRecipes.ToList();
                                    var maxVisible = 2;
                                    var total = categories.Count;

                                    foreach (var cr in categories.Take(maxVisible))
                                    {
                                        <a asp-controller="Categories"
                                           asp-action="Details"
                                           asp-route-id="@cr.Category?.Id"
                                           class="badge pill category-pill me-1 text-decoration-none">
                                            @cr.Category?.Name
                                        </a>
                                    }

                                    if (total > maxVisible)
                                    {
                                        <span class="badge pill category-pill me-1">
                                            +@(total - maxVisible) more
                                        </span>
                                    }
                                }
                                else
                                {
                                    <span class="text-muted">No Categories</span>
                                }
                            </div>









                            <div class="small text-muted mt-2 mb-2">
                                <span class="fw-semibold">Time:</span> @item.FormattedTotalTime
                            </div>

                            @* Clamp long descriptions to ~100 chars for tidy cards *@
                            @if (!string.IsNullOrEmpty(item.Description))
                            {
                                <p class="card-text">
                                    @(item.Description.Length > 100
                                        ? item.Description.Substring(0, 100) + "..."
                                        : item.Description)
                                </p>
                            }
                            else
                            {
                                <p class="card-text text-muted">No description available.</p>
                            }

                            @* Body is clickable to Details; header/footer remain interactive *@
                            <a asp-action="Details" asp-route-id="@item.Id" class="stretched-link"></a>
                        </div>

                        <!-- ===================== Card Footer ===================== -->
                        <div class="card-footer d-flex justify-content-between align-items-center">
                            @{
                                var owner = ((Dictionary<string, (string Email, bool IsAdmin)>)ViewBag.OwnerInfo)[item.AuthorId];
                            }

                            <small class="text-muted">
                                By
                                <a>
                                    @if (owner.IsAdmin)
                                    {
                                        <i class="bi bi-shield-fill-check" title="Admin"></i>
                                    }
                                    @owner.Email
                                </a>
                            </small>

                            @* Owner-only controls (unchanged) *@
                            @if (isOwner || User.IsInRole("Admin"))
                            {
                                <div class="btn-group">
                                    <a asp-action="Edit" asp-route-id="@item.Id" class="btn btn-sm btn-primary">Edit</a>
                                    <a asp-action="Delete" asp-route-id="@item.Id" class="btn btn-sm btn-danger">Delete</a>
                                </div>
                            }
                        </div>
                    </div>
                }
            }
        </div>
    </div>

    <!-- ===================== Scripts ===================== -->
    @section Scripts {
        <script>
            // Reusable brown alert (appears bottom-right, fades out after 2.5s)
            let activeAlert = null; // track current alert

            function showAlert(message, type = "brown") {
                // Remove any existing alert
                if (activeAlert) {
                    activeAlert.remove();
                    activeAlert = null;
                }

                const alert = document.createElement("div");
                alert.className = `alert alert-${type} fade show position-fixed bottom-0 end-0 m-3 shadow`;
                alert.style.zIndex = "1050";
                alert.style.transition = "opacity 0.5s ease";
                alert.textContent = message;

                document.body.appendChild(alert);
                activeAlert = alert;

                setTimeout(() => {
                    alert.style.opacity = "0";
                    setTimeout(() => {
                        alert.remove();
                        activeAlert = null;
                    }, 500);
                }, 2500);
            }

            const isRecipeIndex = window.location.pathname.toLowerCase().includes("/recipes");

            document.addEventListener('submit', async (e) => {
                const form = e.target;
                if (!form.matches('form[action*="Favorites/Toggle"]')) return;
                e.preventDefault();

                const icon = form.querySelector('i');
                if (!icon) return;

                const recipeName = form.dataset.recipeName || "Recipe";
                const wasFav = icon.classList.contains('bi-star-fill');

                // Optimistic UI feedback
                icon.classList.toggle('bi-star');
                icon.classList.toggle('bi-star-fill');
                icon.classList.toggle('unchecked');

                try {
                    const res = await fetch(form.action, {
                        method: 'POST',
                        body: new FormData(form),
                        headers: { 'X-Requested-With': 'XMLHttpRequest' }
                    });

                    if (!res.ok) throw new Error();

                    showAlert(wasFav
                        ? `Removed '${recipeName}' from favorites.`
                        : `Added '${recipeName}' to favorites!`);

                    // Fade out card if removing from favorites tab
                    if (isRecipeIndex && window.location.search.includes("scope=favorites") && wasFav) {
                        const card = form.closest('.recipe-card');
                        if (card) {
                            card.style.transition = "opacity 0.5s ease";
                            card.style.opacity = "0";
                            setTimeout(() => card.remove(), 500);
                        }
                    }

                } catch {
                    // Revert star on failure
                    icon.classList.toggle('bi-star');
                    icon.classList.toggle('bi-star-fill');
                    icon.classList.toggle('unchecked');
                    showAlert(`Something went wrong with '${recipeName}'. Please try again.`, "danger");
                }
            });

            document.addEventListener('submit', async (e) => {
                const form = e.target;

                // Only handle Like/Dislike forms
                if (!form.matches('form[action*="Votes/ToggleLike"], form[action*="Votes/ToggleDislike"]'))
                    return;

                e.preventDefault(); // stop full page form submit

                try {
                    const res = await fetch(form.action, {
                        method: 'POST',
                        body: new FormData(form),
                        headers: { 'X-Requested-With': 'XMLHttpRequest' }
                    });

                    if (!res.ok) throw new Error();

                    // Reload so both buttons + counts reflect server-side toggle logic
                    window.location.reload();
                } catch {
                    alert("Vote failed — please try again.");
                }
            });
        </script>
    }
</div>
